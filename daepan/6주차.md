## 3.3 라우터의 패킷 중계 동작

### 3.3.1 라우터의 기본
라우터는 네트워크에서 패킷을 수신하고 목적지 주소를 바탕으로 최적의 경로를 찾아 패킷을 중계하는 장비입니다. 주로 IP 주소를 기반으로 작동합니다.

라우터의 내부구조는 중계와 포트 부분으로 나뉩니다.
- **라우터의 내부 구조**
라우터의 중계 기능은 크게 라우팅 (중계) 부분과 포트(인터페이스)부분으로 나뉘어져 있습니다. 이 두 부분은 라우터의 핵심 구성 요소이며, 패킷의 전달과 관련된 다양한 작업을 처리합니다.

1. 라우팅 (중계) 부분:
    * 라우팅 알고리즘을 실행하고 라우팅 테이블을 관리합니다.
    * 패킷의 목적지 IP 주소를 검사하여 해당 패킷을 어느 포트로 전달해야 할지 결정합니다.
    * 이 부분은 라우터의 두뇌 역할을 합니다. 모든 라우팅 결정과 관련된 연산이 여기에서 이루어집니다.

2. 포트 (인터페이스) 부분:
    * 패킷을 물리적으로 수신하거나 전송하는 역할을 합니다.
    * 각 포트는 특정 네트워크 링크 (예: 이더넷, Wi-Fi, 광섬유)와 연결되어 있으며, 해당 링크의 통신 표준 및 속도에 따라 작동합니다.
    * 포트는 라우팅 부분에서 결정된 경로를 기반으로 패킷을 실제 네트워크로 전송하는 물리적인 장치입니다.

- **예제**: A라는 컴퓨터가 B라는 컴퓨터에 데이터를 전송하고자 할 때, 라우터는 포트 부분에서 A의 패킷을 물리적으로 수신합니다. 이후, 라우팅 부분은 패킷의 목적지 주소를 검사하고, 라우팅 테이블을 참조하여 B로의 최적 경로를 결정합니다. 결정된 경로에 따라 포트 부분은 패킷을 해당 출력 포트로 전송하게 됩니다.

### 3.3.2 경로표에 등록된 정보
라우터는 경로표(라우팅 테이블)를 통해 다양한 경로 정보를 저장하고 관리합니다. 이 테이블에는 목적지 주소, 넥스트 홉 주소, 출력 인터페이스 등의 정보가 포함됩니다.

* 스위칭 허브와의 비교
- 라우터와 스위칭 허브는 둘 다 네트워크 장비이지만, 그들의 작동 원리와 관리하는 정보가 다릅니다:

1. 스위칭 허브 (Switch)

* 주로 MAC 주소를 기반으로 작동합니다.
* MAC 주소 테이블을 가지고 있어, 특정 MAC 주소가 어느 포트에 연결되어 있는지 추적합니다.

- **예제**: 스위칭 허브의 MAC 주소 테이블에는 "AA:BB:CC:DD:EE:FF의 MAC 주소는 1번 포트에 연결되어 있다"라는 정보가 있을 수 있습니다.

2. 라우터 (Router)

* 주로 IP 주소를 기반으로 작동합니다.
* 라우팅 테이블을 가지고 있어, 특정 IP 주소 또는 IP 주소 범위가 어떤 경로로 전달되어야 하는지 결정합니다.

- **예제**: 경로표에는 "192.168.1.0/24 네트워크로 가는 가장 빠른 경로는 eth0 인터페이스를 통해 192.168.1.1이다"라는 정보가 저장될 수 있습니다.

여기서 라우터는 호스트 번호를 무시하고 네트워크 번호 부분만 조사한다

### 메트릭 (Metric) 이란?
* 메트릭은 라우터가 여러 가능한 경로 중에서 최적의 경로를 선택할 때 사용하는 "비용" 또는 "가중치"
* 메트릭 값은 네트워크의 특정 경로의 상대적인 품질이나 성능을 나타내며, 낮은 메트릭 값을 가진 경로가 더 선호되는 경로로 간주됩니다.

- 메트릭은 여러 요소를 기반으로 계산될 수 있습니다:
  1. 홉 수 (Hop Count): 패킷이 목적지까지 도달하기 위해 거쳐야 하는 라우터나 스위치의 수.
  2. 대역폭 (Bandwidth): 경로에 있는 링크의 대역폭.
  3. 지연 시간 (Latency): 패킷이 출발점에서 목적지까지 도달하는 데 걸리는 시간.
  4. 신뢰성 (Reliability): 링크의 오류율이나 신뢰성.
  5. 로드 (Load): 네트워크 링크의 현재 트래픽 양.

> 각 라우팅 프로토콜마다 메트릭을 계산하는 방법이 다를 수 있습니다. 예를 들어, RIP (Routing Information Protocol)는 홉 수를 
> 기반으로 메트릭을 계산하며, OSPF (Open Shortest Path First)는 대역폭을 주요 메트릭으로 사용합니다.

- **예제**: 라우터가 A, B, C 세 가지 경로를 통해 동일한 목적지에 패킷을 전송할 수 있다고 가정해봅시다. A 경로의 메트릭이 5, B 경로의 메트릭이 3, C 경로의 메트릭이 7일 경우, 라우터는 메트릭 값이 가장 낮은 B 경로를 통해 패킷을 전송합니다.

### 3.3.3 라우터의 패킷 수신동작
라우터가 패킷을 수신하면, 먼저 패킷의 헤더를 확인하여 목적지 주소를 파악합니다.

먼저 신호가 커넥터 부분에 도착하면 PHY(MAU) 회로와 MAC 회로에서 신호를 디지털 데이터로 변환합니다. 그리고 패킷 끝 부분의 FCS를 대조하여 오류의 유무를 점검합니다.

이후 정상인 경우 MAC 헤더의 수신처 MAC 주소가 자신에게 해당하는지 조사합니다.

1. 수신처 MAC 주소가 해당하는 경우
    - 해당한 패킷을 수신 버퍼 메모리에 저장한ㄴ다.

2. 수신처 MAC 주소가 해당하지 않는 경우
    - 패킷을 폐기한다.


- **예제**: A가 192.168.1.10 주소로 패킷을 전송하면, 라우터는 이 패킷을 수신하여 192.168.1.10으로 가는 경로를 찾습니다.

### 3.3.4 경로표를 검색하여 출력포트를 발견한다.
라우터는 수신된 패킷의 IP 헤더를 검사하여 목적지 IP 주소를 확인합니다. 이 주소는 라우터의 경로표 (라우팅 테이블)와 비교됩니다, 이를 통해 패킷을 전송할 출력 포트를 결정합니다.

MAC 헤더는 패킷이 현재 라우터에 도달하기 위해 사용되었던 물리적 경로 정보를 담고 있습니다. 이 정보는 라우터에 도착한 후에는 더 이상 필요하지 않기 때문에, 라우터는 MAC 헤더를 제거합니다.

경로표에서 수신처를 찾을 때, 넷마스크 항목은 목적지 IP 주소의 네트워크 부분만을 참조하여 경로표 내의 항목과 일치하는지 확인합니다. 이렇게 하면, 라우터는 특정 네트워크로의 최적 경로를 결정할 수 있습니다.

그러나, 여러 경로가 동일한 네트워크로 이어질 수 있기 때문에, 이러한 경우 라우터는 여러 후보 경로 중에서 메트릭을 기반으로 최적의 경로를 선택합니다.

### 3.3.5 해당하는 경로가 없는 경우에 선택하는 기본 경로
경로표에 해당 주소가 없을 경우, 라우터는 기본 경로(디폴트 라우트)를 사용하여 패킷을 전송합니다.
여기에 등록된 라우터를 기본 게이트웨이라고 합니다.

- **예제**: 라우터는 10.10.10.10 주소로 가는 경로 정보가 없다면, 설정된 기본 경로를 통해 패킷을 전달합니다.

### 3.3.6 패킷은 유효기한이 있다.
각 패킷에는 Time-to-Live (TTL) 값이 있어, 이 값이 0이 되면 패킷은 폐기됩니다. 이는 무한 루프를 방지합니다.

- **예제**: 패킷의 TTL이 처음에 64로 설정되었을 경우, 각 라우터를 거칠 때마다 1씩 감소하며, 0이 되면 해당 패킷은 폐기됩니다.

### 3.3.7 큰 패킷은 조각 나누기 기능으로 분할한다.
패킷의 크기가 해당 네트워크의 MTU (Maximum Transmission Unit)보다 클 경우, 해당 패킷은 여러 조각으로 나누어져야 합니다. 이런 과정을 "패킷 조각내기" 또는 "패킷 분할"이라고 합니다.

**플래그 필드에 대한 설명**
* IPv4 헤더 내에는 "플래그"라는 섹션이 있으며, 이 섹션은 3비트로 구성됩니다. 
* 이 중에서 두 번째 비트는 "DF (Don't Fragment)" 플래그라고 불리며, 패킷의 분할을 허용할지 여부를 결정합니다.

> **DF (Don't Fragment) 플래그** </br>
> DF 플래그가 설정되면 (값이 1이면), 패킷은 분할될 수 없습니다.
> 패킷의 크기가 MTU보다 크고 DF 플래그가 설정된 경우, 
> 라우터는 해당 패킷을 버리고, ICMP "Fragmentation Needed but DF Set" 메시지를 송신 호스트에게 전송합니다.

**동작 방식**
1. 라우터가 패킷을 수신하면, 패킷의 크기와 MTU 값을 비교합니다.
2. 패킷 크기가 MTU보다 크고 DF 플래그가 설정되지 않았다면, 라우터는 패킷을 여러 조각으로 나눕니다.
    * 각 조각은 원래 패킷의 일부 데이터와 새로운 IP 헤더를 포함하며, 조각화된 패킷은 동일한 목적지로 전송됩니다.
    * 목적지에서 조각화된 패킷은 다시 원래의 패킷으로 재조립됩니다.
</br>
</br>

- **예제**:Alice가 2000바이트 크기의 패킷을 Bob에게 전송하려고 합니다. 이 네트워크의 MTU는 1500바이트입니다. 패킷의 DF 플래그가 설정되지 않았다면, 라우터는 패킷을 두 조각으로 나눕니다: 첫 번째 조각은 1500바이트, 두 번째 조각은 나머지 500바이트입니다. 이렇게 나누어진 패킷 조각들은 Bob에게 전송되며, Bob의 시스템에서 다시 원래의 2000바이트 패킷으로 재조립됩니다.

> 만약 DF 플래그가 설정된 상태에서 Alice가 동일한 크기의 패킷을 전송하려  했다면, 
> 라우터는 패킷을 버리고 Alice에게 오류 메시지를 반환합니다.

### 3.3.8 라우터의 송신동작은 컴퓨터와 같다.
라우터의 송신 동작이 컴퓨터의 송신 동작과 유사하다는 것은, 패킷을 전송하기 전에 물리적 주소, 즉 MAC 주소를 확인하고 패킷에 적절한 헤더 정보를 첨부하는 과정이 포함된다는 것을 의미합니다. 이때 중요한 역할을 하는 것이 ARP (Address Resolution Protocol)입니다.

- **ARP (Address Resolution Protocol)에 대한 설명** :
ARP는 IP 주소를 해당 네트워크의 물리적 주소, 즉 MAC 주소로 변환하는 프로토콜입니다. 네트워크 상의 장치가 다른 장치로 패킷을 전송하려면, 해당 장치의 MAC 주소를 알아야 합니다. ARP는 이 MAC 주소를 찾기 위해 사용됩니다.

  1. ARP 요청: 송신자는 네트워크 상의 모든 장치에게 ARP 요청을 브로드캐스트합니다. 이 요청은 "이 IP 주소를 가진 장치의 MAC 주소가 무엇인가?"라는 질문을 포함하고 있습니다.
  2. ARP 응답: 해당 IP 주소를 가진 장치는 ARP 응답을 송신자에게 유니캐스트로 전송합니다. 이 응답은 해당 장치의 MAC 주소를 포함하고 있습니다.
  3. 주소 캐싱: 송신자는 응답을 받아서 MAC 주소를 알게 되면 이 정보를 일정 시간 동안 캐싱합니다. 이후 동일한 주소로 데이터를 전송할 때는 ARP 요청을 다시 보내지 않고 캐시된 정보를 사용합니다.

### 3.3.9 라우터와 스위칭 허브의 관계
라우터는 네트워크 계층에서 작동하는 반면, 스위칭 허브는 데이터 링크 계층에서 작동합니다. 라우터는 IP 주소를, 스위칭 허브는 MAC 주소를 기반으로 통신합니다.

데이터의 맨 앞에서 MAC 헤더를 부가한다고 표현하지만 이더넷의 패킷의 데이터 부분에 IP의 패킷을 넣는다고 표현하는 것이 원래의 개념에 맞습니다.

MAC 헤더를 부가하여 패킷을 송신한다는 것은 이더넷의 패킷의 데이터 부부분에 IP의 패킷을 넣고 이더넷의 원리로 다음 라우터까지 운반한다는 것입니다.

즉, 패킷을 어디까지 운반할 것인가에 대해서 생각해보면 라우터가 스위칭 허브에 의뢰할 떄의 개념을 잘 이해할 수 있습니다.

**IP가 이더넷에 의뢰하는 것은 최종 목적지까지 패킷을 운반하는 것이 아니라 다음 라우터에 패킷을 운반하는 것입니다.**

MAC 헤더를 만들 때 IP 경로표에서 다음 라우터의 IP 주소를 조사하고 여기에서 ARP로 조사한 MAC 주소를 수신처 MAC 주소에 기록합니다.

그리고 다음 라우터까지의 패킷을 운반하도록 고쳐서 이더넷에 의뢰합니다.

- **예제**: A와 B가 같은 로컬 네트워크에 있을 때, 스위칭 허브는 A와 B의 MAC 주소를 사용하여 데이터를 전송합니다. 그러나 다른 네트워크에 있을 때는 라우터를 통해 IP 주소를 기반으로 데이터가 전송됩니다.

## 3.4 라우터의 부가 기능

### 3.4.1 주소 변환으로 IP 주소를 효율적으로 이용한다.
Network Address Translation (NAT)는 내부 네트워크의 프라이빗 주소를 외부 네트워크의 글로벌 주소로 변환하여 통신을 가능하게 하는 라우터의 기능입니다. 이를 통해 IP 주소의 효율적 사용 및 네트워크 보안을 동시에 강화할 수 있습니다.

1. 프라이빗 주소 (Private IP Address):

    * 특정 범위의 IP 주소로, 외부 인터넷에 직접 노출되지 않는 주소입니다.
    * 주로 로컬 네트워크 (예: 회사, 가정) 내의 장치들에 할당됩니다.
    * IPv4에서 주요 프라이빗 주소 범위는 10.0.0.0 - 10.255.255.255, 172.16.0.0 - 172.31.255.255 및 192.168.0.0 - 192.168.255.255입니다.

2. 글로벌 주소 (Public or Global IP Address):

    * 인터넷상에서 유일한 주소로, 외부 네트워크와 통신할 때 사용됩니다.
    * ISP (Internet Service Provider)로부터 할당받습니다.
    * **패킷 필터링**은 들어오거나 나가는 네트워크 트래픽을 검사하여, 정의된 규칙에 따라 트래픽을 허용하거나 차단하는 보안 기능입니다.

- **예제**: 회사 내부 네트워크의 컴퓨터 A는 프라이빗 주소 192.168.1.10을 가지고 있습니다. 이 컴퓨터가 인터넷에 접속하려 할 때, NAT를 통해 이 주소는 회사의 글로벌 주소 (예: 203.0.113.5)로 변환되어 전송됩니다. 동시에, 패킷 필터링을 통해 인터넷에서 악성 코드나 불필요한 트래픽이 내부 네트워크로 들어오는 것을 방지합니다.

### 3.4.2 주소 변환의 기본 동작
NAT (Network Address Translation)는 내부 네트워크의 IP 주소와 포트 번호를 외부 네트워크의 IP 주소와 포트 번호로 변환하는 기술입니다. 이 변환은 주로 라우터나 방화벽에서 이루어지며, 사설 IP 주소를 공용 IP 주소로 변환하여 외부와의 통신을 가능하게 합니다.

* **동작 과정**:

1. 요청: 내부 장치가 외부 서버에 접속하려고 할 때, 해당 요청 패킷은 사설 IP 주소와 출발지 포트 번호를 가지고 있습니다.
2. 주소 및 포트 번호 변환: 라우터의 NAT 기능은 패킷의 출발지 주소 및 포트를 공용 IP 주소와 새로운 포트 번호로 변환합니다. 이 변환 정보는 NAT 테이블에 저장됩니다, 이렇게 해서 같은 사설 IP 주소에서 여러 요청이 있을 경우, 각 요청은 공용 IP 주소의 다른 포트 번호와 연결될 수 있습니다.
응답 수신: 외부 서버는 응답 패킷을 변환된 공용 IP 주소와 포트 번호로 전송합니다.
3. 주소 및 포트 번호 재변환: 라우터는 NAT 테이블을 참조하여 응답 패킷의 목적지 주소 및 포트를 원래의 사설 IP 주소와 포트 번호로 재변환하고, 해당 내부 장치로 전송합니다.

> 이러한 방식으로, NAT는 내부 네트워크의 여러 장치가 하나의 공용 IP 주소를 사용하여 동시에 인터넷을 사용할 수 있도록 합니다. 
> 포트 주소 변환을 통해, 같은 내부 IP 주소의 여러 요청을 구분하고, 각 요청에 대한 응답을 올바른 내부 장치로 전달합니다

- **예제**:
회사의 내부 네트워크에 있는 두 개의 컴퓨터 A와 B가 각각 인터넷에 있는 서버 X와 Y에 접속하려고 합니다.

컴퓨터 A의 IP 주소: 192.168.1.10, 포트: 2000
컴퓨터 B의 IP 주소: 192.168.1.11, 포트: 2000
두 컴퓨터는 같은 포트 번호를 사용하고 있지만, NAT를 사용하는 라우터 덕분에 두 컴퓨터 모두 인터넷에 접속할 수 있습니다.

라우터의 NAT 기능은 컴퓨터 A의 주소와 포트를 공용 IP 주소 203.0.113.5:3000으로, 
컴퓨터 B의 주소와 포트를 공용 IP 주소 203.0.113.5:3001로 변환합니다.

서버 X는 응답을 203.0.113.5:3000 주소로, 서버 Y는 203.0.113.5:3001 주소로 보냅니다. 
라우터는 NAT 테이블을 참조하여 이 응답을 각각 컴퓨터 A와 B로 올바르게 전달합니다.

### 3.4.3 포트 번호를 바꿔쓰는 이유
포트 번호 변경은 여러 내부 장치가 같은 공용 IP 주소를 사용하여 외부와 통신할 때 서로의 데이터 통신을 구분하고, 각각의 요청과 응답을 올바르게 연결하기 위함입니다. 이때 사용되는 IP 주소 중, 프라이빗 주소는 회사나 가정 내부 네트워크에서만 유효하며 외부로 나갈 때는 글로벌 주소로 변환되어야 합니다.

**예제** :
회사 내에 두 명의 직원, 직원 A와 직원 B가 각각의 컴퓨터로 동시에 외부의 같은 웹사이트에 접속하려고 합니다. 
> 두 컴퓨터는 회사의 내부 네트워크에서 각각 프라이빗 주소 192.168.1.10과 192.168.1.11을 갖습니다.
</br>

> 회사의 라우터는 NAT를 사용하여 이 두 주소를 회사의 단일 글로벌 주소, 예를 들어 203.0.113.5, 로 변환합니다. </br>
>하지만 두 직원이 동일한 웹사이트에 접속하려 할 때 동일한 글로벌 주소를 사용하면 통신을 구분할 수 없습니다. </br>
> 이때 라우터는 포트 번호를 바꿔쓰며, 직원 A의 요청은 203.0.113.5:5000, </br>
> 직원 B의 요청은 203.0.113.5:5001 과 같이 포트 번호를 다르게하여 외부와의 통신을 구분하게 됩니다.

웹사이트로부터의 응답이 돌아올 때, 라우터는 NAT 테이블을 참조하여 해당 응답이 직원 A의 컴퓨터로 갈지, 직원 B의 컴퓨터로 갈지를 판단하고 올바르게 전달합니다.

### 3.4.4 인터넷에서 회사로 액세스한다.
외부 네트워크에서 회사의 내부 네트워크에 접근하기 위해서는 특정 설정과 절차가 필요합니다. 대표적인 방법으로 VPN (Virtual Private Network)과 포트 포워딩이 있습니다.

1. 대응표 등록: 라우터나 주소 변환 장치에서 사용하는 NAT 테이블을 사전에 설정하는 것을 의미합니다. 특정 외부 접근을 허용하기 위해 미리 글로벌 주소와 포트 번호를 특정 내부 주소와 포트 번호에 매핑하게 됩니다. 이렇게 함으로써, 허용된 접근만 회사의 내부 네트워크 리소스에 액세스하게 됩니다.

2. 주소변환장치: 일반적으로 NAT 장치를 의미합니다. 외부에서의 접근 요청을 내부 네트워크의 적절한 주소와 포트로 변환해주는 역할을 합니다.

- **예제 1**: 원격 지사에서 본사의 내부 네트워크에 접근하려 할 때, VPN을 통해 안전하게 내부 네트워크에 접속할 수 있습니다. VPN은 암호화된 터널을 통해 원격 접속자와 내부 네트워크 간의 안전한 연결을 제공합니다.

- **예제 2**: 회사의 내부 네트워크에 있는 웹 서버에 외부에서 접근하려면, 라우터의 대응표를 사전에 등록하여 특정 글로벌 주소와 포트 번호 (예: 203.0.113.5:80)를 웹 서버의 프라이빗 주소와 포트 번호 (예: 192.168.1.10:80)에 매핑합니다. 이렇게 설정하면 외부 사용자는 글로벌 주소를 통해 안전하게 웹 서버에 접근할 수 있게 됩니다.

### 3.4.5 라우터의 패킷 필터링 기능
라우터의 패킷 필터링 기능을 통해, 네트워크의 보안을 강화할 수 있습니다. 이 기능은 특정 IP 주소, 프로토콜, 포트 번호 등의 조합에 따라 패킷을 차단하거나 허용합니다. 이를 통해 원치 않는 트래픽이 내부 네트워크에 접근하는 것을 방지할 수 있습니다.

라우터는 패킷의 헤더 정보를 검사하여 정의된 규칙에 따라 필터링을 실행합니다. 예를 들어, 특정 프로토콜에 대한 트래픽만 차단하거나 허용할 수 있습니다.

1. **예제 1**: 위에서 언급한 것처럼, 회사 라우터는 보안 정책에 따라 포트 22(SSH)로의 모든 외부 접근을 차단할 수 있습니다. 이렇게 함으로써, 외부의 악의적인 사용자가 SSH를 통한 무단 접근을 시도할 경우, 라우터에서 해당 패킷을 차단하게 됩니다.

2. **예제 2**: 라우터의 필터링 규칙을 사용하여, ICMP 프로토콜을 통한 모든 트래픽을 차단할 수 있습니다. 이렇게 설정하면, 회사 네트워크는 외부에서의 핑(Ping) 요청이나 다른 ICMP 기반의 공격을 방어할 수 있습니다.

이와 같이, 라우터의 패킷 필터링 기능은 특정 프로토콜, 포트, 소스 또는 목적지 IP 주소 등의 조합을 기반으로 동작하며, 이를 통해 내부 네트워크의 보안을 강화하는 역할을 합니다.