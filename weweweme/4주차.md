## 2.5. IP와 이더넷의 패킷 송・수신 동작

### 2.5.1. 패킷의 기본

![UDP와 TCP/IP의 패킷](https://blog.kakaocdn.net/dn/YErlN/btrpjvv1oUz/jeBlvTrXNIGKzr4GFR80ck/img.gif) 

- 데이터 통신의 근간을 이루는 '패킷'은 다양한 레이어와 프로토콜을 거치며 전송된다. 
- 패킷은 일반적으로 헤더와 데이터의 두 부분으로 구성되어 있다. 
    - 헤더에는 수신처의 IP 주소, 송신처의 IP 주소, 다른 제어 정보 등이 포함되고, 데이터 부분은 실제로 전송할 내용을 담고 있다.

- TCP와 IP의 관계 : TCP는 통신 상대와 소통할 때 전송 계층에서 작동한다. 
    - 이곳에서 생성된 데이터는 **세그먼트** 로 나뉘어 IP(네트워크 계층)에 의뢰되어 **IP 패킷** 으로 캡슐화된다.
- 패킷과 이더넷 프레임 : IP 패킷은 더 나아가 **이더넷 프레임** 으로 캡슐화되어 물리적 네트워크를 통해 전송된다. 
    - 여기서 이더넷 프레임은 패킷의 **운송 수단** 같은 역할을 한다.


### 2.5.2. 패킷 송・수신의 개요

#### 기본적인 패킷의 송・수신 절차
1. 패킷의 송신을 담당하는 엔드노드(종단장치)가 패킷을 생성한다.
2. 패킷은 라우터나 스위치 같은 중계 장치로 송신된다. 이때 라우터는 '라우팅 알고리즘'을 사용해 어디로 패킷을 보낼지 결정한다.
3. 라우터는 미리 저장해둔 '라우팅 테이블'을 확인해 패킷의 목적지를 알아낸다. 이 테이블은 패킷을 어디로, 어떻게 보낼지에 대한 지침서와 같다.
4. 라우터는 테이블과 패킷 정보를 바탕으로 패킷을 어느 방향으로 전달할지 결정한다.
5. 패킷이 목적지에 도착하면, 목적지 엔드노드는 필요에 따라 회답 패킷을 생성하여 송신한다.
6. 이러한 통신에서 엔드노드는 패킷의 최초 송신자 또는 최종 수신자 역할을 하며, 특정 통신 시나리오에 따라 이 두 역할을 교대로 할 수 있다.
    > 특정 통신 시나리오의 예시
    > - P2P 통신 : 두 개의 엔드노드가 서로 직접 통신하는 경우, 두 장치는 각각 송신과 수신 역할을 번갈아 가면서 수행한다.
    > - 클라이언트-서버 모델 : 웹 브라우저(클라이언트)가 웹 서버에 요청을 보내고 웹 서버가 응답을 반환하는 상황에서, 클라이언트와 서버는 각각 송신자와 수신자 역할을 하며 엔드노드가 된다.
    > - 멀티캐스트 : 하나의 송신 엔드노드가 여러 수신 엔드노드에 동시에 데이터를 전송하는 경우, 여러 엔드노드가 특정 시나리오에서 다르게 역할을 수행한다.

#### 종단 장치(엔드노드)
- 네트워크에서 데이터 통신의 출발점이나 종착점이 되는 기기를 의미한다.
- 개인용 컴퓨터, 서버, 스마트폰 등 다양한 형태가 될 수 있으며, 데이터를 생성하거나 소비하는 역할이다.

#### 라우팅 알고리즘
- 라우팅 알고리즘은 라우터가 패킷을 어디로 보낼지 결정하는 '지도'나 '내비게이션' 같은 역할을 한다.
- 라우터 안에서 실행되며, 여러 길 중 가장 효율적인 길을 찾아주는 '길잡이' 역할을 한다.
- 주요 라우팅 알고리즘 예시
    - [Dijkstra's algorithm](https://en.wikipedia.org/wiki/Dijkstra%27s_algorithm) : 가장 짧은 경로를 찾는다.
    - [Bellman–Ford algorithm](https://en.wikipedia.org/wiki/Bellman%E2%80%93Ford_algorithm) : 음수 가중치도 처리할 수 있는 경로를 찾는다.
    - [OSPF(Open Shortest Path First)](https://en.wikipedia.org/wiki/Open_Shortest_Path_First) : 네트워크 구성이 바뀔 때마다 가장 빠른 경로를 찾는다.
    - [BGP(Border Gateway Protocol)](https://en.wikipedia.org/wiki/Border_Gateway_Protocol) : 인터넷과 같은 큰 네트워크에서 경로를 찾는다.

#### 라우팅 테이블
- 라우팅 테이블은 라우터의 주소록과 같다.
- 이 주소록에는 패킷이 어디로 가야 하는지, 그리고 어떻게 가야 가장 좋은지에 대한 정보가 들어 있다.
- 여기에는 목적지의 주소, 다음에 거쳐갈 장소(넥스트 홉)와 거리 같은 '비용' 정보가 포함된다.

#### 유연성과 확장성
- 이 시스템은 매우 유연하다. 예를 들어, 이더넷 대신에 무선 LAN, ADSL 등 다른 기술도 사용할 수 있다.
    - 즉, 네트워크 계층(IP)에서는 어디로 데이터를 보낼 것인지만 결정하고, 실제로 어떤 매체를 통해 데이터를 보낼 것인지는 링크 계층(예: 이더넷, Wi-Fi)에서 처리할 수 있다.
    > 예를 들어, Wi-Fi가 없는 곳에서는 이더넷 케이블을 사용할 수 있고, 이더넷이 불가능한 경우에는 4G 또는 5G 같은 다른 기술을 사용할 수 있다.
- IP와 이더넷(또는 그 대체 기술)은 역할을 나눠 각각 처리하므로, 통신 기술을 적재적소에 적용할 수 있다.
- 이렇게 각 장치와 프로토콜이 역할을 분담함으로써, 네트워크는 더 유연하고 확장 가능해지는 것이다.

#### 물리 계층과 오류 검출
- 데이터 패킷이 실제로 전송되기 전에는 물리 계층에서 여러 처리가 이루어진다.
- LAN 어댑터는 패킷을 전기 신호나 광 신호로 변환하고, 이 과정에서 오류 검출도 수행한다.
- 이더넷 프레임의 경우, [CRC(Cyclic Redundancy Check)](https://en.wikipedia.org/wiki/Cyclic_redundancy_check) 을 통해 데이터의 무결성을 확인한다.

#### 네트워크 계층에서의 패킷 처리
- 네트워크 계층에서는 들어온 패킷의 IP 헤더를 확인한다.
- 헤더를 통해 패킷의 목적지가 자신인지 아닌지를 판단한다.
- 목적지가 자신이 아닌 경우, 더 깊은 패킷 분석 없이 바로 다음 라우터로 패킷을 전달한다.
- 이러한 처리 방식은 효율성을 높이고 시간을 절약하는 데 도움을 준다.
    - || 논리 연산자와의 유사성 : || 연산자는 두 조건 중 하나만 참이면 바로 참을 리턴하고 뒤의 조건은 확인하지 않는다. 
    - 마찬가지로, 네트워크 계층에서는 목적지가 자신이 아니라 판단되면 더 이상 깊은 분석 없이 다음 단계로 넘어간다. 
    - 이 두 과정 모두 최소한의 필요한 처리만을 하여 효율성을 높인다.


### 2.5.3. 수신처 IP 주소를 기록한 IP 헤더를 만든다

#### IP 담당 부분의 역할과 작동 메커니즘
- IP 헤더 생성 : TCP 담당 부분에서 패킷의 송신 및 수신을 요청할 때, IP는 표준 IP 헤더를 생성하여 TCP 헤더 앞에 추가한다.
- 수신처 판단 : IP는 상위 프로토콜(TCP, UDP 등)이 제공하는 정보를 기반으로 수신처를 판단한다. IP는 **best-effort service** 를 제공하므로 수신처의 유효성을 검증하지 않는다.
    - best-effort service : IP는 패킷을 목적지까지 전달하려고 노력하지만, 그 과정에서 발생할 수 있는 여러 문제에 대해서는 책임지지 않는다.
    - 즉, 패킷 전달에 대한 어떠한 **품질 보증(QoS, Quality of Service)** 도 제공되지 않는다는 것을 의미한다.
- 수신처 및 송신처 IP 주소
    - 수신처 IP 주소 : 애플리케이션에서 지정한 상대방의 IP 주소를 이용한다. 잘못 지정된 경우에도 IP는 그대로 이 주소를 사용한다.
    - 송신처 IP 주소 : 이 컴퓨터에 할당된 IP 주소를 사용하지만, 여러 LAN 어댑터가 있는 경우 복잡해질 수 있다.

#### 라우팅 테이블 (경로표) 사용

![경로표 예시](https://www.igloo.co.kr/files/2021/08/25/2021082517383647e9eeae-52d4-4adc-b68b-734e559dfe86.png)

- 라우터 결정: IP는 라우팅 테이블을 참조하여 패킷을 어느 라우터에게 전달할지 결정한다.
- 라우팅 테이블은 동적(dynamic) 또는 정적(static) 방식으로 업데이트 될 수 있다.
    - 정적 라우팅(Static Routing)
        - 정적 라우팅은 네트워크 관리자가 수동으로 라우팅 테이블을 설정하고 관리하는 방법이다.
        - 장점 : 네트워크 구조가 단순하거나 변경이 거의 없는 경우에는 효율적이다.
        - 단점 : 네트워크의 구성이 자주 변경되거나 복잡한 경우에는 관리가 어려울 수 있다.
    - 동적 라우팅(Dynamic Routing)
        - 동적 라우팅은 라우팅 프로토콜을 사용하여 라우터 간에 정보를 교환하고, 라우팅 테이블을 자동으로 업데이트하는 방법이다.
        - 장점 : 네트워크 상태가 동적으로 변할 때 효과적이다. 네트워크의 변경에 자동으로 적응하므로 관리가 쉽다.
        - 단점 : 추가적인 라우팅 프로토콜에 의한 트래픽이 발생하며, 설정이 복잡할 수 있다.
    - 실제 네트워크 환경에서는 정적 라우팅과 동적 라우팅을 혼합하여 사용하는 경우도 많다. 
    - 정적 라우팅은 특정 경로에 대한 고정적인 라우트가 필요한 경우, 동적 라우팅은 그 외의 일반적인 상황에서 사용될 수 있다.
- LAN 어댑터 결정: 라우팅 테이블은 여러 LAN 어댑터 중 어느 것을 사용할지 결정한다.
- 기본 게이트웨이: 라우팅 테이블에 '기본 게이트웨이'라는 항목이 있어, 특별한 라우팅 정보가 없을 경우 이를 사용한다.

#### 프로토콜 및 기타 설정
- 프로토콜 번호: 패킷에 들어있는 데이터가 어떤 프로토콜(TCP, UDP 등)을 사용하는지 나타내는 번호를 설정한다. 
    - 이를 통해 수신처는 패킷을 적절한 프로토콜 스택으로 전달한다.
- 기타 설정: IP 헤더에는 다른 여러 정보도 포함될 수 있다. 이에 대한 자세한 내용은 별도의 챕터에서 논의될 예정이다.


### 2.5.4. 이더넷용 MAC 헤더를 만든다

#### MAC 헤더
- 이더넷에는 TCP/IP 개념이 통용되지 않는다.
- 이더넷의 수신처 판단 구조로 사용하는 것이 MAC 헤더이다.

![MAC 헤더](http://www.ktword.co.kr/img_data/1816_1.JPG)

#### MAC 헤더의 주요 필드
- DA (Destination Address): 목적지 MAC 주소를 뜻하며 6바이트 (48비트) 길이를 가진다. 
    - 이 주소는 이더넷 프레임이 어디로 전달되어야 하는지를 나타낸다.
    - MAC 헤더가 만들어지는 시점에는 정확히 누구에게 패킷을 건네주어야할지 모른다.
    - 따라서 경로표에서 찾은 일치하는 행의 Gateway 항목에 기록되어 있는 IP 주소의 기기가 패킷을 건네줄 상대가 된다.
- SA (Source Address): 송신자의 MAC 주소이며 6바이트 (48비트) 길이를 가진다.
    - 이 주소는 이더넷 프레임이 어디에서 시작된 것인지를 나타낸다.
    - 자신의 LAN 어댑터의 MAC 주소를 설정한다.
    - MAC 주소는 LAN 어댑터를 제조할 때 해당 기기의 ROM에 기록되며, 이 값을 가져와 설정한다.
- [태그 (Tag, 필요시)](http://www.ktword.co.kr/test/view/view.php?m_temp1=3479&id=844): 추가 정보를 제공할 수 있는 옵션 필드이다.
    - 이 필드는 필요에 따라 추가될 수 있으며, 일반적으로는 4바이트 길이를 가진다.
- Length/Type: 이 필드는 2바이트 길이를 가지며, 다음에 오는 데이터의 유형 (IPv4, IPv6, ARP 등) 또는 길이를 나타낸다.
    - 주로 **EtherType Code** 를 사용하여 프로토콜을 식별한다.
    - [EtherType Code](http://www.ktword.co.kr/test/view/view.php?m_temp1=2039&id=852) : 다음에 오는 프로토콜 데이터 단위(PDU)의 타입을 지정한다.
    

### 2.5.5. ARP로 수신처 라우터의 MAC 주소를 조사한다

#### ARP 프로토콜의 역할
- 수신처의 MAC 주소를 알기 위해 사용되는 것이 ARP 프로토콜이다.
    - ARP 요청 패킷은 로컬 네트워크 내에서 특정 IP 주소를 가진 장치를 찾기 위해 브로드캐스트된다.
    - 만약 존재한다면, 해당 장치는 자신의 MAC 주소를 반환한다.

#### ARP 캐시의 활용
- 매번 동작을 수행하면 ARP 패킷의 연산이 낭비되어 한 번 조사한 결과는 ARP 캐시에 보관하여 다시 이용한다.
    - ARP 캐시의 유효 시간 (TTL)이 지나면 자동으로 삭제된다.
- 패킷을 송신할 때 우선 ARP 캐시를 조사하여 사용한다.

#### ARP 캐시의 한계와 문제점
- ARP 캐시에 저장된 MAC 주소를 계속 사용하면 문제가 있을 수 있다.
    - 저장된 값과 현실이 일치하지 않을 경우가 있다.
- 이것을 막기 위해 저장된 값은 일정 시간이 지나면 삭제하는데 ARP 캐시의 TTL을 통해 관리된다.
- 보안 측면에서도 ARP는 본래 보안을 고려하지 않은 설계이므로, ARP 스푸핑 같은 공격에 취약하다.
    - ARP 스푸핑 : 공격자가 ARP 패킷을 조작하여 네트워크 내의 장치들이 잘못된 MAC 주소 정보를 캐시하게 만드는 공격이다.
    - 보안 취약성의 원인 : ARP는 패킷의 출처를 검증하지 않기 때문에, 누구나 ARP 응답을 보낼 수 있다.
    - 해결 방안 : 정적 ARP 항목을 설정하거나, ARP 스푸핑을 탐지할 수 있는 보안 소프트웨어를 사용하는 등의 방법이 있다.


### 2.5.6. 이더넷의 기본

![이더넷의 형태](https://static.javatpoint.com/computer/images/what-is-ethernet2.png)

- 이더넷은 다수의 컴퓨터가 여러 상대와 자유롭게 적은 비용으로 통신하기 위해 고안된 기술이다.
- 이더넷 네트워크는 케이블, 스위치, 라우터 등 여러 구성 요소로 이루어져 있다.
    - 컴퓨터가 신호를 송신하면, 케이블을 통해 네트워크의 모든 장치에 신호가 전달된다.
    - 신호의 맨 앞 부분에는 수신처의 정보가 포함되어 있어, 해당하는 장치만 패킷을 수신하고 나머지 장치들은 패킷을 무시한다.
    - 이 동작을 제어하기 위해 MAC 헤더를 사용한다.




### 2.5.7. IP 패킷을 전기나 빛의 신호로 변환하여 송신한다

![LAN Card 내부 구조](http://ebook.pldworld.com/_eBook/-Telecommunications,Networks-/NETWORK_DOCUMENTs/semina/my/comm05/lancard1.gif)

#### 디지털 데이터의 변환
- IP 프로토콜에 의해 생성된 패킷은 메모리에 저장된 디지털 데이터이기 때문에 그대로 상대방에게 전송할 수 없다.
- 이러한 디지털 데이터를 전기 또는 빛의 신호로 변환하는 것이 네트워크에서의 송수신 동작의 본질이다.
- 이 변환 동작을 수행하는 하드웨어는 LAN 어댑터이다.
    - LAN 어댑터는 드라이버 소프트웨어에 의해 제어된다.

#### 초기화 과정
- LAN 어댑터는 전원이 공급되고, 운영체제가 부팅될 때 초기화 작업을 수행한다.
- 초기화 과정에는 하드웨어 진단, 초기 설정 등이 포함되며, 이 중에서도 MAC 주소를 설정하는 과정이 있다.
    - 네트워크 어댑터의 대표적인 초기 설정은 다음이 있다.
        - IP 주소나 다른 네트워크 설정의 자동 또는 수동 할당
        - 포트 설정 및 프로토콜 초기화
        - 버퍼 사이즈, 큐 관리 등과 같은 성능 관련 설정
        - 보안 설정 (방화벽, 암호화 등)

#### MAC 주소 설정
- LAN 어댑터의 ROM에는 전 세계적으로 중복되지 않도록 제조 시점에서 MAC 주소가 기록된다.
- 특수한 경우에는 명령어나 설정 파일을 통해 MAC 주소를 수동으로 변경할 수 있다. 이때 ROM에 기록된 MAC 주소는 무시된다.
    - 특수한 경우에는 다음과 같은 상황이 있다.
        - 네트워크 보안을 강화하기 위해 MAC 주소를 일정 주기로 변경하는 경우
        - 특정 네트워크에 연결하기 위해 허용된 MAC 주소 목록에 있는 주소로 변경해야 하는 경우
        - 하드웨어를 교체한 후 원래의 네트워크 설정을 유지하고 싶은 경우
        - 특정 서비스나 애플리케이션에서 원래의 MAC 주소를 필요로 하지 않는 경우


### 2.5.8. 패킷에 3개의 제어용 데이터를 추가한다

![이더넷 프레임 패킷](http://www.ktword.co.kr/img_data/2965_1.jpg)

#### LAN 드라이버와 데이터
- LAN 드라이버는 IP 담당 부분에서 패킷을 받으면 LAN 어댑터의 버퍼 메모리에 저장한다.
- 복사를 마친 후 패킷을 송신하도록 MAC 회로에 명령을 보낸다.
- MAC 회로는 송신 패킷을 버퍼 메모리에서 추출한다.
- 맨 앞에는 프리앰블과 스타트 프레임 딜리미터라는 두 개의 데이터를, 맨 끝에는 프레임 체크 시퀀스(FCS)라는 오류 검출용 데이터를 추가한다.

#### Preamble
- 프리앰블은 송신하는 패킷을 읽을 때의 타이밍을 잡기 위해 사용되는 제어 데이터이다.
    - 이는 네트워크의 다양한 구성 요소(라우터, 스위치, 컴퓨터 등)가 서로 다른 동작 속도나 타이밍을 가질 수 있으므로 중요하다.
- 구조 : 주로 반복되는 '101010...' 같은 비트 패턴으로 이루어져 있으며, 이는 수신기에게 "이제 데이터가 올 것"이라는 사실을 알려준다.
    - 이 패턴을 정확히 인식하면, 수신기는 뒤이어 오는 실제 데이터를 정확히 해석할 준비가 되어 있게 된다.
    > 빅뱅의 거짓말 노래로 예시를 들면, 익숙한 Intro의 전화번호 누르는 소리를 들으면 아 이번 곡 거짓말이라고 인식하는 것과 비슷하다.
- 동기화 : 수신기는 이 비트 패턴을 인식하여 클럭을 동기화하고, 데이터 스트림에서 실제 데이터 프레임의 시작점을 정확하게 찾을 준비를 한다.
- 오류 최소화 : 프리앰블의 동기화 기능은 데이터 전송 과정에서의 비트 오류 가능성을 줄이는 역할을 한다.
- 다목적성 : 프리앰블은 단순히 타이밍만을 조절하는 것이 아니라, 시스템 간의 시간 동기화, 버퍼링, 데이터의 정확한 해석 등에도 기여한다.

#### SFD(Starting Frame Delimiter)
- SFD는 마지막 비트 패턴이 다르며, 수신측은 이를 이용하여 신호에서 데이터를 추출한다. 
    - 즉, SFD가 패킷의 시작을 나타낸다.
- 패킷의 수신을 시작할 타이밍을 정확히 알리는 역할을 한다.
    > 거짓말로 더 들자면, [MV](https://youtu.be/NeDeZUqNiVo?si=-CLf5dSvMl6-Zhih) 기준 0:40초 경 Yeah~ 이후부터 가사가 나오는데, Yeah 부분을 예시로 들 수 있다.

#### FCS(Frame Check Sequence)
- FCS는 패킷을 운반하는 도중 잡음 등의 영향으로 데이터가 변질될 경우 이를 검출하기 위한 것이다.
- Ethernet에서는 주로 32비트의 비트열을 사용한다.
- FCS는 **CRC(Cyclic Redundancy Check)** 의 한 형태로 작동한다. 
    - [CRC](http://www.ktword.co.kr/test/view/view.php?nav=2&no=603&sh=CRC)는 특정 계산식에 기초하여 패킷의 전체 내용을 검사하는 방법이다.


### 2.5.9. 허브를 향해 패킷을 송신한다
- 패킷을 허브로 전송하기 위해, 먼저 MAC 회로가 데이터를 프레임 형태로 만든다.
    - 프레임에는 목적지와 출발지의 MAC 주소가 포함된다.
- 이 프레임은 PHY 회로를 거쳐 전기적 신호로 변환된다.
    - 변환된 신호는 해당하는 이더넷의 표준(10BASE-T, 100BASE-TX 등)에 따라 전송된다.
- 이 변환된 신호는 허브를 통해 목적지로 전달된다.
    - 리피터 허브와 스위칭 허브 두 가지 유형의 허브가 있다.
    - 리피터 허브는 주로 반이중 모드에서 작동하며, 신호를 증폭해 다른 포트로 전달한다.
    - 스위칭 허브는 전이중 모드가 가능하며, MAC 주소를 분석하여 패킷을 특정 포트로만 전달한다.
    - 이 설명에서는 반이중 모드에 중점을 둘 것이며, 추가적인 내용은 추후에 다룰 예정이다.
- 반이중 모드는 한 번에 하나의 방향으로만 데이터를 전송할 수 있다.

#### PHY와 MAC 회로
- PHY (Physical Layer Entity) 회로와 MAC (Media Access Control) 회로는 이더넷 카드 내에 존재하며, 물리 계층과 데이터 링크 계층에서 중요한 역할을 한다.
    - PHY 회로 : 물리 계층에서 신호 변환, 코딩/디코딩, 클럭 복구 등을 담당한다. 이는 실제로 데이터를 전기적 신호로 변환하여 네트워크 매체(케이블)에 전송하는 역할을 한다.
    - MAC 회로 : 데이터 링크 계층에서 프레임의 생성과 주소 지정을 담당한다. 이는 PHY 회로를 통해 전송될 데이터 패킷에 MAC 주소 정보를 첨부한다.

#### 이더넷의 신호
- 이더넷에서 전송하는 신호는 전기적인 형태로, 대표적인 파생 형식은 다음과 같다.
    - [10BASE-T](http://www.ktword.co.kr/test/view/view.php?nav=2&no=869&sh=10BASE-T) : 10 Mbps의 속도로 동작하며 UTP 케이블을 사용한다.
    - [100BASE-TX](http://www.ktword.co.kr/test/view/view.php?nav=2&no=879&sh=100BASE-TX) : 100 Mbps의 속도로 동작하며 더 높은 품질의 UTP 또는 STP 케이블을 사용한다.
    - [1000BASE-T](http://www.ktword.co.kr/test/view/view.php?nav=2&no=1165&sh=1000BASE-T) : 1 Gbps의 속도로 동작하며 더 높은 품질의 UTP 케이블을 사용한다.
- 이더넷은 신호가 제대로 도착했는지 확인하지 않으며, 이 역할은 TCP가 담당한다.

#### 충돌
- 신호를 송신 중 다른 신호가 동시에 수신되면 충돌 이 발생한다.
    - 충돌이 발생하면 **재밍 신호(Jamming Signal)** 를 통해 다른 기기에 알린다. 
    - 재밍 신호는 다른 기기들이 충돌을 감지하게 해주는 특수한 신호이다.
- 충돌 발생 후 랜덤한 시간 동안 대기한 후 재전송을 시도한다. 랜덤한 시간은 보통 백오프 알고리즘을 사용해 산정한다.
    - 백오프 알고리즘이란, 충돌이 발생한 후 각 디바이스가 재전송을 시도하기 전에 대기해야 하는 시간을 랜덤하게 결정하는 알고리즘이다.
    - 이 알고리즘은 모든 디바이스가 동시에 재전송을 시도해 다시 충돌을 유발하는 것을 방지하기 위해 사용된다.
- 네트워크가 혼잡해지면 데이터를 전송하는 디바이스 간에 '충돌'의 가능성이 증가한다.
    - 현대의 이더넷 환경에서는 이러한 문제를 해결하기 위해 스위치를 사용한다. 스위치를 사용하면 충돌 도메인을 줄일 수 있어, 충돌이 덜 발생한다.
- 충돌 도메인은 네트워크 내에서 두 개 이상의 디바이스가 동시에 데이터를 전송할 때 그 영향을 받는 구간을 의미한다.
    - 즉, 한 디바이스가 데이터를 전송 중일 때, 다른 디바이스도 동시에 같은 구간으로 데이터를 전송하면 '충돌'이 발생하는 그 구간을 말한다.


### 2.5.10. 돌아온 패킷을 받는다
- 이더넷 환경에서, 반이중 모드와 리피터 허브를 사용할 경우, 1대의 디바이스가 송신한 신호는 연결된 케이블을 통해 모든 곳에서 흐른다.

#### 패킷 수신 동작 과정
1. 신호 수신 : 맨 앞의 프리앰블부터 신호를 받아 들이고, 이를 기반으로 타이밍을 결정한다.
2. 디지털 데이터 변환 : SFD (Start Frame Delimiter)를 인식하면, 그 다음 비트부터는 디지털 데이터로 변환된다.
3. PHY에서 MAC으로 : 이 때, PHY 회로는 수신한 신호를 공통된 형식으로 변환하여 MAC 회로에 전달한다.
4. FCS 확인 : MAC 회로는 패킷의 FCS (Frame Check Sequence)를 계산하고, 이를 패킷 끝의 FCS 값과 비교한다.
5. 주소 확인과 버퍼 저장 : MAC 헤더의 수신처 주소를 확인하여 자신에게 온 패킷인지 확인하고, 해당하는 경우에만 버퍼 메모리에 저장한다.
6. 패킷 수신 통지 : 패킷을 성공적으로 수신하면, 이 정보는 컴퓨터 본체에 인터럽트를 통해 알려진다.

#### 인터럽트 처리
- LAN 어댑터는 인터럽트 신호선을 통해 본체의 인터럽트 컨트롤러에 신호를 보낸다.
- 이로 인해 CPU는 현재 작업을 일시 중단하고, OS의 인터럽트 처리 프로그램으로 제어가 이동한다.
- 여기에서 LAN 드라이버가 호출되어, 수신한 패킷을 처리한다.

#### 프로토콜과 애플리케이션 판별:
- LAN 드라이버는 MAC 헤더의 타입 필드를 통해 패킷이 어떤 프로토콜을 사용하는지 확인한다.
- 이 정보를 바탕으로 프로토콜 스택은 어떤 애플리케이션에 패킷이 전달되어야 할지 결정한다.


### 2.5.11. 서버의 응답 패킷을 IP에서 TCP로 넘긴다
- 서버에서 패킷이 돌아온 것으로 간주하고 다음 프로토콜 스택의 동작을 추적해 보자.

#### IP Layer (IP 담당 부분)
- LAN 드라이버가 수신한 패킷을 IP 프로토콜 스택에 전달한다.
- IP 레이어는 수신한 패킷의 헤더를 조사하여, 포맷에 문제가 없고 수신처 IP 주소가 자신과 일치하는지 확인한다.
- 수신처 IP 주소가 다르면 ICMP 메시지를 사용하여 오류를 통지하고 패킷을 폐기한다.

#### Fragmentation and Reassembly
- IP 헤더에는 패킷의 분할 정보가 플래그와 프래그먼트 오프셋으로 기록되어 있다.
- 분할된 패킷이면, IP 레이어는 이를 임시 메모리에 저장하고, 동일한 ID 정보를 가진 다른 패킷들이 도착할 때까지 기다린다.
- 모든 분할 패킷이 도착하면, 이들을 원래의 패킷으로 병합한다
    - 이를 리어셈블링(reassembling)이라 한다.

#### TCP Layer (TCP 담당 부분)
- IP 레이어의 작업이 끝나면, 패킷을 TCP 레이어에 전달한다.
- TCP는 IP 헤더와 TCP 헤더의 정보를 사용하여 해당 패킷을 처리할 소켓을 찾는다.

#### Application Layer (애플리케이션 담당 부분)
- TCP 레이어는 패킷의 데이터 부분을 애플리케이션 레이어의 수신 버퍼에 저장한다.
- 애플리케이션은 이 버퍼에서 데이터를 가져가 처리한다.


## 2.6. UDP 프로토콜을 이용한 송・수신 동작

### 2.6.1. 수정 송신이 필요없는 데이터의 송신은 UDP가 효율적이다

#### UDP와 TCP의 차이점 이해
- UDP를 이해하는 요점은 TCP 안에 있다.
- TCP의 동작은 복잡하지만, 그 복잡함의 이유를 이해하면 UDP의 존재 이유가 명확해진다.
- 복잡한 TCP는 데이터를 확실하면서도 효율적으로 전달하기 위한 목적을 가지고 있다.

#### UDP의 메커니즘
- UDP는 비연결성이기 때문에 세션의 설정이나 종료가 필요 없다.
- UDP는 데이터를 보내고, 수신 측에서 별도의 확인 응답 없이도 다음 데이터를 계속 보낼 수 있다.
- 만약 데이터 패킷이 도착하지 않았다면, 그냥 다시 보내면 된다.
- 회신이 있을 경우, 이것은 애플리케이션 레벨에서 수신 확인 응답을 대신할 수 있다. UDP 자체는 이러한 기능을 제공하지 않는다.

#### UDP의 오류 처리 및 적용 사례
- UDP는 패킷의 순서나 무결성을 자체적으로 확인하지 않는다. 이러한 오류 처리는 애플리케이션 레벨에서 해야한다.
- 실시간 스트리밍 등 몇몇 패킷의 손실이 크게 문제를 일으키지 않는 경우에 UDP가 적합하다.


### 2.6.2. 제어용 짧은 데이터
- 예를 들어, DNS (Domain Name System) 서버에 대한 조회는 대체로 한 개의 패킷으로 끝나므로 UDP를 사용하는 경우가 많다.
- 애플리케이션 레벨에서 데이터를 생성한 뒤, 운영 체제나 네트워크 스택이 UDP 헤더를 부착하고 IP로 전송한다.
- 수신은 IP 헤더와 UDP 헤더에서 수신처 IP 주소, 송신처 IP 주소, 수신처 포트 번호, 그리고 송신처 포트 번호를 확인하여 알맞은 애플리케이션으로 데이터를 전달한다.
- 만약 패킷이 유실되면, UDP는 이를 별도로 알리지 않는다. 이러한 **Fire-and-Forget** 특성은 애플리케이션 레벨에서 처리해야 할 것이다.
    - Fire-and-forget은 UDP가 데이터 패킷을 한 번 보내고 (fire), 그 후에 패킷이 도착했는지 여부를 확인하지 않는 (forget) 방식을 의미한다.

#### UDP 패킷 헤더 구조

![UDP 패킷 1](http://www.ktword.co.kr/img_data/323_1.JPG)
![UDP 패킷 2](http://www.ktword.co.kr/img_data/323_2.jpg)

- 발신/수신 포트 번호
    - UDP는 TCP와 마찬가지로 16비트의 포트 번호를 사용하여 통신하는 애플리케이션을 식별한다.
- 길이
    - 패킷의 전체 길이를 바이트 단위로 표시한다.
    - 최소 길이는 8 바이트 (헤더만 포함될 때)이고, 최대 길이는 65,535 바이트다.
    - 실제 사용 가능한 최대 크기는 IP 헤더와 UDP 헤더의 크기를 제외한 65,507 바이트이다.
- 체크섬
    - 데이터의 무결성을 확인하기 위한 선택적인 항목이다.
    - 체크섬 값이 0이면, 수신측은 체크섬 계산을 하지 않는다.


### 2.6.3. 음성 및 동영상 데이터
- 음성이나 영상 데이터를 전송할 때 UDP를 주로 사용한다. 
- 결정된 시간 내에 데이터를 전달해야 하기 때문에 UDP가 적합하다.
- 데이터의 도착이 지연되면 재생 타이밍이 맞지 않아 음성이 끊기거나 영상이 멈춘다.
    - 이런 문제는 '버퍼링'과 같은 기술로 어느 정도 완화할 수 있다.
- 음성이나 영상에는 데이터가 일부 누락되더라도 치명적인 문제가 되지 않는 성질이 있다.
    - 음성 데이터의 경우, 누락된 부분에서 노이즈가 발생할 수 있다.
    - 영상 데이터의 경우, 영상이 일시적으로 멈출 수 있다.
- 그러나 이러한 누락이 일정 수준을 넘으면 사용자 경험에 영향을 줄 수 있다.

#### 결론
- 다시 보낼 필요가 없거나 다시 보내도 쓸모가 없다면 단순히 UDP로 데이터를 보내는 쪽이 더 효율적이다.
 

---

# 참고자료
- [MAC Frame - kt정보통신기술용어해설](http://www.ktword.co.kr/test/view/view.php?nav=2&no=1816&sh=mac+%ED%97%A4%EB%8D%94)
- [What is Ethernet?](https://www.javatpoint.com/what-is-ethernet)
- [통신의 이해 5. LAN CARD의 이해](http://ebook.pldworld.com/_eBook/-Telecommunications,Networks-/NETWORK_DOCUMENTs/semina/my/comm05/comm5.htm)
- [이더넷 프레임 - kt정보통신기술용어해설](http://www.ktword.co.kr/test/view/view.php?m_temp1=2965)
- [Frame Check Sequence - kt정보통신기술용어해설](http://www.ktword.co.kr/test/view/view.php?m_temp1=873&id=744)
- [Preamble - kt정보통신기술용어해설](http://www.ktword.co.kr/test/view/view.php?nav=2&no=1817&sh=preamble)
- [백오프알고리즘 - AWS](https://docs.aws.amazon.com/ko_kr/freertos/latest/userguide/backoffalgorithm-library.html)
- [UDP - kt정보통신기술용어해설](http://www.ktword.co.kr/test/view/view.php?nav=2&no=323&sh=UDP+%ED%97%A4%EB%8D%94)
- [Fire and Forget](https://medium.com/mandiri-engineering/fire-and-forget-e59b745c9f97)