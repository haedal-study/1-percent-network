## 3.3. 라우터의 패킷 중계 동작

### 3.3.1. 라우터의 기본

#### 라우터의 내부 구조
- 라우터의 구조는 중계 부분과 포트 부분으로 구성된다.
- 중계 부분은 패킷의 목적지 IP 주소를 참조하여 라우팅 테이블을 검색하고 패킷을 올바른 포트로 전달한다.
- 포트 부분은 특정 통신 기술의 규칙에 따라 패킷을 수신하거나 전송한다.
    - 이더넷 포트: 전통적인 유선 연결에 사용되며, MAC 주소를 기반으로 데이터 프레임을 처리한다.
    - [무선 LAN](http://www.ktword.co.kr/test/view/view.php?nav=2&no=2157&sh=%EB%AC%B4%EC%84%A0+LAN) 포트 : 무선 주파수를 사용하여 데이터를 전송하며, Wi-Fi 표준에 따라 동작한다.
    - [ADSL](http://www.ktword.co.kr/test/view/view.php?nav=2&no=242&sh=adsl) 포트 : 전화선을 사용한 디지털 데이터 전송을 위한 포트로, ADSL 모뎀과 함께 사용되며, 데이터와 음성 신호를 분리한다.
    - [FTTH](http://www.ktword.co.kr/test/view/view.php?nav=2&no=598&sh=ftth) 포트 : 광섬유를 통한 고속 인터넷 접속을 지원하는 포트로, 광섬유 신호를 전기 신호로 변환하여 라우터의 중계 부분에 전달한다.
- 결정된 포트로 패킷을 전송하며, 해당 포트는 포트 부분의 규칙에 따라 패킷을 송신한다.

#### 라우터와 스위칭 허브의 차이점
- 동작 위치
    - 라우터는 IP 주소를 기반으로 하는 네트워크 계층에서 동작한다.
    - 스위칭 허브는 MAC 주소를 기반으로 하는 데이터 링크 계층에서 동작한다.
- 동작 방식
    - 스위칭 허브는 들어온 프레임을 단순히 전송만 한다.
    - 라우터의 포트는 패킷의 목적지나 출발지로서의 기능을 수행한다.


### 3.3.2. 경로표에 등록된 정보

#### 라우팅 테이블의 개념
- 스위칭 허브와 라우터 모두 중계 대상을 조사하기 위해 테이블을 사용한다.
- 그러나 두 장치는 다른 주소 체계를 취급하므로 해당 테이블의 내용도 다르다.
- 스위칭 허브의 테이블은 MAC 주소 테이블이라 부른다.
- 라우터의 테이블은 라우팅 테이블 또는 경로표 라고 부른다.
    - 맨 왼쪽의 수신처 항목에는 목적지 정보, 즉 서브넷 마스크가 포함된다.
    - 라우터는 이 항목에 등록된 IP 주소와 수신한 패킷의 목적지 IP 주소를 비교하며, 주로 네트워크 번호만을 조사한다.

![주소 집약](https://t1.daumcdn.net/cfile/tistory/2133954254FEC51819?original)

#### 서브넷 주소와 호스트 주소
- 실제 서브넷에 할당된 서브넷 마스크와 경로표에 등록된 서브넷 마스크 값은 다를 수 있다.
- **주소 집약(Address Aggregation)** 을 사용하면 여러 서브넷을 하나의 서브넷으로 묶어 경로표를 등록할 수 있다.
    - 주소 집약은 여러 개의 작은 네트워크 주소 범위를 하나의 큰 네트워크 주소로 표현하는 것이다.
- **서브네팅(Subnetting)** 은 반대로 한 서브넷을 세분화는 것으로 여러 서브넷처럼 경로표에 나타낼 수 있다.
- 주소 집약과 서브네팅의 사용 시기
    - 주소 집약은 여러 개의 작은 네트워크가 연속된 IP 주소를 지니거나 라우팅 테이블의 크기를 줄이기 위해 사용된다.
    - 서브네팅 하나의 큰 네트워크를 여러 개의 작은 서브넷으로 나누거나 특정 서브넷에 대한 라우팅 정책을 변경하고자 할 때 사용된다.

#### 메트릭
- 메트릭은 패킷을 전송하는 데 필요한 비용이나 거리를 나타내는 지표이다.
- 낮은 메트릭 값은 더 가까운 또는 비용이 적은 경로를 나타낸다.
- 라우팅 결정을 할 때 어떤 경로를 선택할 것인지 결정하는 데 사용된다.
- 라우팅 테이블에 나타나며, 라우팅 프로토콜마다 기준이 다르다.

#### 경로 등록 방법
- 라우터와 스위칭 허브의 등록 원리는 다르다.
    - 스위칭 허브는 패킷 중계 동작 중 MAC 주소 테이블에 자동으로 등록한다.
    - 라우터에서의 경로 정보 등록이나 갱신은 패킷 중계 동작과 분리되어 있으며 두 가지 방법이 있다.
        - 관리자에 의해 수동으로 등록 또는 갱신된다.
        - 라우팅 프로토콜을 사용하여 라우터 간에 정보를 교환하고 자동으로 경로표를 갱신한다.


### 3.3.3. 라우터의 패킷 수신 동작
- 다양한 유형의 라우터 포트가 있지만, 여기서는 이더넷 포트에서의 패킷 수신 동작을 기준으로 한다.
- 패킷 수신 과정
    1. 신호 도착 : 먼저 외부에서 온 신호가 라우터의 커넥터 부분에 도착한다.
    2. PHY 변환 : 해당 신호는 내부의 PHY(Physical Layer) 회로를 거쳐 전기적 신호에서 디지털 데이터로 변환된다.
    3. MAC 처리 : 변환된 디지털 데이터는 MAC(Media Access Control) 회로로 전달되어 링크 계층의 처리가 이루어진다.
    4. FCS 검사 : 패킷의 끝에 위치한 FCS(Frame Check Sequence)를 통해 패킷에 오류가 있는지 점검한다.
    5. MAC 주소 확인 : MAC 헤더의 목적지 주소를 확인하여 해당 주소가 라우터에 속한 것인지 판별하며, 해당 주소가 라우터의 것이라면 패킷을 내부의 수신 버퍼 메모리에 저장한다. 
- 이렇게 라우터는 받은 패킷을 적절히 처리하며, 필요한 경우 내부 네트워크로 전송한다.


### 3.3.4. 경로표를 검색하여 출력 포트를 발견한다

#### MAC 헤더의 처리
- 패킷이 라우터에 도착하면 MAC 헤더가 폐기된다.
- 라우터는 L3에서 동작하기 때문에, IP 헤더를 기반으로 패킷의 중계와 전달 결정을 한다.

#### IP 헤더의 검토 및 경로표 비교
- 다음 단계에서는 IP 헤더의 내용을 참조하여 패킷 중계 동작을 실시한다.
- 패킷의 목적지 IP 주소의 네트워크 부분을 조사하여 경로표의 수신처 항목과 비교하여 해당하는 행을 찾는다.

#### 우회 경로와 메트릭의 적용
- 경로표에서는 서브넷 마스크의 값에 따라 IP 주소의 네트워크 부분만을 비교한다.
- 경우에 따라 같은 네트워크 번호의 길이를 가진 여러 행이 존재할 수 있다.
    - 이는 라우터의 고장, 케이블 단선 등의 상황을 대비하여 여러 우회 경로를 갖는 경우에 해당한다.
- 이런 상황에서는 메트릭 값으로 최적의 경로를 판단한다.

#### 패킷의 폐기와 ICMP 메시지 전송
- 만약 경로표에서 해당하는 행을 발견하지 못하면, 라우터는 패킷을 폐기한다.
- 이후 [ICMP](http://www.ktword.co.kr/test/view/view.php?nav=2&no=94&sh=Icmp) 메시지를 통해 송신처에 패킷의 미도착을 알린다.

#### 라우터와 스위칭 허브의 차이점
- 스위칭 허브는 주로 수천 대 정도의 비교적 작은 네트워크에서 동작한다.
- 라우터의 경우 큰 인터넷 규모의 네트워크에서 동작하기 때문에 패킷을 폐기하는 것이다.


### 3.3.5. 해당하는 경로가 없는 경우에 선택하는 기본 경로
- 라우터는 현실적으로 모든 목적지에 대한 경로를 가지고 있을 수 없다.
- 이런 상황에서, 서브넷 마스크가 0.0.0.0 인 경로는 모든 주소와 일치하는 핵심적인 역할을 한다.
- 이 서브넷 마스크에 라우터 주소를 등록하면, 다른 항목에 일치하는 경로가 없을 경우 패킷은 이 기본 경로로 중계된다.
- 이를 **기본 경로** 라고 부르며, 여기에 등록된 라우터는 **기본 게이트웨이** 라고 한다.


### 3.3.6. 패킷은 유효 기간이 있다
- 패킷이 경로표에서 대상을 찾은 뒤에는 패킷을 전송한다.
- 하지만 전송 전 라우터에서는 TTL 값을 감소시키는 것이다.
    - 라우터를 경유할 때마다 TTL을 1씩 감소시키며, 이 값이 0이 되면 패킷을 폐기한다.
- 이 기능의 주요 목적은 네트워크에 무한 루프 상태로 패킷이 순환하는 것을 방지하는 것이다.


### 3.3.7. 큰 패킷은 조각 나누기 기능으로 분할한다
- 라우터는 다양한 통신 회선을 지원하는데, 각각의 회선 및 LAN은 서로 다른 최대 패킷 길이를 가진다.
- 패킷의 크기가 해당 출력측의 최대 패킷 길이를 초과할 경우 IP는 [조각 나누기(fragmentation)](http://www.ktword.co.kr/test/view/view.php?nav=2&no=393&sh=Fragmentation) 기능을 통해 패킷을 분할한다.
    - 이는 TCP의 데이터 분할과는 별개다.

#### 조각 나누기 동작 과정
1. 출력측의 MTU를 확인하고, 중계하려는 패킷이 그대로 송신될 수 있는지 판단한다.
2. 패킷의 길이를 포트의 종류에 맞춰 결정하며, 헤더의 길이는 MTU 산출에서 제외된다.
3. MTU와 패킷의 길이를 비교해, MTU가 크면 분할하지 않는다.
4. MTU보다 패킷이 크면 IP 헤더의 플래그 필드를 확인해 분할 가능 여부를 결정한다.
5. 플래그 필드가 분할 불가로 설정되어 있다면, 패킷은 폐기되고 ICMP를 통해 송신처에 알린다.
6. 분할이 가능하면, MTU 크기에 맞게 조각 나누기를 수행한다. TCP 헤더 이후의 부분도 대상으로 포함된다.
7. IP 헤더의 일부 필드는 조각 나누기 과정에서 수정되며, 이는 분할된 패킷 정보를 표현하기 위함이다.


### 3.3.8. 라우터의 송신 동작은 컴퓨터와 같다
- 여기서는 LAN에 사용되는 라우터의 경우, 출력측 포트가 이더넷인 상황을 기준으로 설명한다.
- 이더넷의 송신 동작은 규격에 따라 정해져 있으므로, 기기의 종류와 무관하게 동일한 방식으로 수행된다.

#### 송신 과정
1. MAC 헤더의 수신처 MAC 주소 필드를 설정하기 위해 경로표의 게이트웨이 항목을 참조하여 패킷을 전달할 상대를 결정한다.
2. 게이트웨이 항목에 IP 주소가 있으면 해당 IP 주소를 사용하며, 없는 경우 IP 헤더의 수신처 IP 주소를 사용한다.
3. 결정된 상대의 IP 주소에 대응하는 MAC 주소는 ARP를 통해 조회한다. 라우터에는 ARP 캐시가 있어, MAC 주소 정보가 존재하지 않을 경우에만 ARP 조회가 수행된다.
4. MAC 헤더의 송신처 MAC 주소 필드에는 라우터 출력측 포트의 MAC 주소가 설정된다.
5. 패킷이 준비되면 전기 신호로 변환되어 포트를 통해 송신된다. 
    - 만약 출력측 포트가 이더넷 포트라면, 이 패킷은 네트워크 내의 다음 목적지(스위칭 허브, 라우터 등)로 전송된다.
6. 패킷은 이러한 과정을 거쳐 최종적으로 목적지에 도달한다.


### 3.3.9. 라우터와 스위칭 허브의 관계

#### 기초 동작 원리의 차이
- 라우터는 IP 개념에 기반하여 동작하며, 스위칭 허브는 이더넷 개념에 기반하여 동작한다.
- 이 둘 사이의 주요한 차이는 IP와 이더넷의 관계에 있다.

#### 패킷의 전달 경로
- 전체 패킷 전달 동작은 IP(라우터)가 주도한다.
- 각각의 중간 전달 단계, 즉 다음 라우터까지의 패킷 운반은 이더넷(스위칭 허브)가 담당한다.



## 3.4. 라우터의 부가 기능

### 3.4.1. 주소 변환으로 IP 주소를 효율적으로 이용한다
- 현재 라우터는 기본 동작 외에도 몇 가지 부가 기능을 가지고 있다.
- 그 중 주소 변환과 패킷 필터링은 특히 중요하다.

#### 주소 변환
- 주소는 각 기기를 식별하기 위한 것으로, 다른 것과 중복되지 않는 고유한 주소를 할당하는 것이 기본 원칙이다.
- 1990년대 들어 인터넷이 일반에게 공개된 이후, 사용자 수가 급증하면서 고유한 주소의 부족 문제가 부각되었다.
- 패킷을 전달하는 원리의 기반은 고유한 주소 할당에 기반하기 때문에, 장래에 주소가 고갈될 우려가 있었다.
- 이 문제를 해결하기 위해, 주소를 공유하는 새로운 방식을 도입하게 되었다.
- 따라서 주소를 private address와 public address로 구분하기 시작했다.

#### 프라이빗 주소(private address)
- private 주소는 특별한 구조를 가진 것이 아닌, 원래의 public 주소에 포함되어 있던 주소 중에서 특정 범위를 정하여 내부적으로만 사용하기로 한 것이다.
- 이 주소는 중앙에서 일원화하여 관리할 필요가 없으므로 누구나 자유롭게 사용할 수 있다.
- 사내 네트워크의 기기들은 private 주소를 할당받아 사용한다. 이 기기들이 인터넷과 통신할 때, 내부의 private 주소는 공용 IP 주소로 변환되어야 한다.
- 이 주소 변환 작업을 수행하는 기술을 NAT(Network Address Translation) 또는 간단히 **주소 변환** 이라고 한다.


### 3.4.2. 주소 변환의 기본 동작
- 주소 변환, 일명 NAT(Network Address Translation)의 주요 기능은 패킷 중계 시 IP 헤더에 포함된 IP 주소와 포트 번호를 변경하는 것이다.

#### 초기 접속과 주소 변경
- 어떤 기기가 인터넷에 접속하려 할 때, 그 기기의 private IP 주소는 NAT 장치에 의해 public IP 주소로 변환된다.
- 이 변환 과정에서 사용되는 public IP 주소는 NAT 장치에 할당된 외부 IP 주소이다. 또한, 통신에 사용되는 포트 번호도 변경될 수 있다.

#### NAT 테이블과 주소 기록
- 기기의 원래 주소(private 주소와 포트 번호)와 바뀐 주소(public 주소와 포트 번호)는 NAT 장치의 테이블에 저장된다.
- 기기가 인터넷을 통해 서버에 데이터를 보내면, 서버는 바뀐 public 주소로 응답을 보낸다.
- 서버로부터 받은 응답은 NAT 장치에서 원래의 private 주소로 다시 바꾸어 기기에 전송된다.

#### 테이블 참조와 패킷 중계
- 패킷을 주고받을 때는 NAT 테이블을 참조하여 해당 주소의 대응 관계를 확인하고, 패킷을 올바른 대상에게 중계한다.
- 데이터 송수신이 완료되고 연결이 종료되면, NAT 테이블에서 해당 연결 정보는 삭제된다.


### 3.4.3. 포트 번호를 바꿔쓰는 이유
- 초기의 주소 변환(NAT) 기술은 주소만을 변환하였다. 이렇게 할 경우, 각 프라이빗 주소를 인터넷에 접속시킬 때마다 개별적인 글로벌 주소가 필요하게 된다. 
    - 즉, 프라이빗 주소와 글로벌 주소가 1대1로 대응될 필요가 있다.
- 하지만 클라이언트측의 포트 번호는 대부분의 OS에서 동적으로 할당되기 때문에, 이를 바꿔쓰는 것이 큰 문제가 되지 않는다. 
- 이렇게 포트 번호를 변경함으로써 여러 개의 내부 주소가 하나의 글로벌 주소로 대응될 수 있게 되어 글로벌 주소의 효율적인 사용이 가능해진다.
- 포트 번호는 16비트로 표현되므로 총 65,536개의 가능한 값이 있다. 이는 많은 내부 주소를 하나의 글로벌 주소에 매핑할 수 있게 해준다.


### 3.4.4. 인터넷에서 회사로 액세스 한다
- 사내에서 인터넷으로 액세스할 때, 대응표에 송신처의 프라이빗 주소와 포트 번호가 등록되어 있을 필요가 없다. 패킷은 그대로 중계된다.
- 주소 변환 시 사용하는 글로벌 주소는 주소 변환 장치(라우터)에 할당되어 있으며, 포트 번호는 사용 가능한 것 중 하나를 선택한다.
- 반면, 인터넷에서 사내로 들어오는 패킷을 중계하려면 해당 패킷의 정보가 대응표에 반드시 등록되어 있어야 한다.
- 대응표에 정보가 없다면 주소 변환 장치는 글로벌 주소와 프라이빗 주소 간의 매칭을 알 수 없어 패킷을 중계할 수 없다.
    - 즉, 인터넷에서 특정 사내 기기로 액세스하려면 해당 기기가 먼저 인터넷에 액세스하는 동작을 시작해야 한다.
- 사용 중이지 않은 포트 번호로는 패킷을 수신할 수 없다.
- 따라서, 사내 기기가 인터넷으로부터의 접근을 시작하지 않았다면, 외부에서는 그 기기로 패킷을 보낼 수 없다.
- 이 방식은 외부 공격자로부터의 원치 않는 접근을 방지하게 해준다.


### 3.4.5. 라우터의 패킷 필터링 가능
- 패킷 중계 시에는 MAC 헤더, IP 헤더, 그리고 TCP 헤더에 담긴 정보를 검토한다.
- 패킷 필터링은 사전에 설정된 조건과 일치할 경우 해당 패킷을 중계하거나 버리는 과정을 의미한다.
- 많은 방화벽과 소프트웨어는 이런 원리를 활용해 부정적인 침입을 차단한다.


---

# 참고자료
- [Address Aggregation - kt정보통신기술용어해설](http://www.ktword.co.kr/test/view/view.php?m_temp1=2421)
- [Subnetting - kt정보통신기술용어해설](http://www.ktword.co.kr/test/view/view.php?m_temp1=961&id=846)
- [Routing Metric - kt정보통신기술용어해설](http://www.ktword.co.kr/test/view/view.php?nav=2&no=1919&sh=%EB%A9%94%ED%8A%B8%EB%A6%AD)
- [Redundant PathsRedundant Paths](https://www.auvik.com/franklyit/blog/simple-network-redundancy/)
- [NAT - kt정보통신기술용어해설](http://www.ktword.co.kr/test/view/view.php?nav=2&no=1676&sh=NAT)
- [주소 변환 - kt정보통신기술용어해설](http://www.ktword.co.kr/test/view/view.php?nav=2&no=2745&sh=%EC%A3%BC%EC%86%8C+%EB%B3%80%ED%99%98)
- [포트 번호 - kt정보통신기술용어해설](http://www.ktword.co.kr/test/view/view.php?nav=2&no=5149&sh=%ED%8F%AC%ED%8A%B8+%EB%B2%88%ED%98%B8)